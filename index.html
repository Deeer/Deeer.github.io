<!doctype html>
<html class="theme-next use-motion theme-next-mist">
<head>
  

<meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>






  <link rel="stylesheet" type="text/css" href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5"/>


<link rel="stylesheet" type="text/css" href="/css/main.css?v=0.4.3"/>


    <meta name="description" content="代码手工艺人 | Love Linux  | 追求体验" />



  <meta name="keywords" content="Love,Dee" />



  <link rel="alternate" href="/atom.xml" title="Dee+'s Blog" type="application/atom+xml" />



  <link rel="shorticon icon" type="image/x-icon" href="/favicon.ico?v=0.4.3" />



<script type="text/javascript" id="hexo.configuration">
  var CONFIG = {
    scheme: 'Mist',
    analytics: {
      baidu: '',
      google: ''
    },
    sidebar: 'post'
  };
</script>




  <title> Dee+'s Blog </title>
</head>

<body>
<!--[if lte IE 8]> <div style=' clear: both; height: 59px; padding:0 0 0 15px; position: relative;margin:0 auto;'> <a href="http://windows.microsoft.com/en-US/internet-explorer/products/ie/home?ocid=ie6_countdown_bannercode"><img src="http://7u2nvr.com1.z0.glb.clouddn.com/picouterie.jpg" border="0" height="42" width="820" alt="You are using an outdated browser. For a faster, safer browsing experience, upgrade for free today or use other browser ,like chrome firefox safari." style='margin-left:auto;margin-right:auto;display: block;'/></a></div> <![endif]-->
  <div class="container one-column 
   page-home 
">
    <div class="headband"></div>

    <div id="header" class="header">
      <div class="header-inner">
        <h1 class="site-meta">
  <span class="logo-line-before"><i></i></span>
  <a href="/" class="brand">
      <span class="logo">
        <i class="icon-logo"></i>
      </span>
      <span class="site-title">Dee+'s Blog</span>
  </a>
  <span class="logo-line-after"><i></i></span>
</h1>


  <ul id="menu" class="menu">
     
    
      
      <li class="menu-item menu-item-home">
        <a href="/">
          <i class="menu-item-icon icon-home"></i> <br />
          Home
        </a>
      </li>
    
      
      <li class="menu-item menu-item-categories">
        <a href="/categories">
          <i class="menu-item-icon icon-categories"></i> <br />
          Categories
        </a>
      </li>
    
      
      <li class="menu-item menu-item-archives">
        <a href="/archives">
          <i class="menu-item-icon icon-archives"></i> <br />
          Archives
        </a>
      </li>
    
      
      <li class="menu-item menu-item-tags">
        <a href="/tags">
          <i class="menu-item-icon icon-tags"></i> <br />
          Tags
        </a>
      </li>
    
      
      <li class="menu-item menu-item-about">
        <a href="/about">
          <i class="menu-item-icon icon-about"></i> <br />
          About
        </a>
      </li>
    
  </ul>


      </div>
    </div>

    <div id="main" class="main">
      <div class="main-inner">
        <div id="content" class="content">
          
  <div id="posts" class="posts-expand">
    
      

  <div class="post post-type-normal ">
    <div class="post-header">

      
      
        <h1 class="post-title">
          
          
            
              <a class="post-title-link" href="/2018/06/27/runtime源码阅读（一）/">
                runtime源码阅读（一）
              </a>
            
          
        </h1>
      

      <div class="post-meta">
        <span class="post-time">
          Posted on 2018-06-27
        </span>

        
          <span class="post-category">
            &nbsp; | &nbsp; In
            
              <a href="/categories/Read-iOS/">Read iOS</a>

              
              

            
          </span>
        

        
          
        
      </div>
    </div>

    <div class="post-body">

      
      

      
        
          <h2 id="runtime源码阅读"><a href="#runtime源码阅读" class="headerlink" title="runtime源码阅读"></a>runtime源码阅读</h2><p>首先是对象的初始化</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">  void _objcInit(void) &#123;</span><br><span class="line">	static int _done = <span class="number">0</span>;</span><br><span class="line">	int hidx;</span><br><span class="line">        <span class="comment">/* Protect against multiple invocations, as all library</span></span><br><span class="line"><span class="comment">         * initializers should. */</span></span><br><span class="line">        if (<span class="number">0</span> != _done) return;</span><br><span class="line">        _done = <span class="number">1</span>;</span><br><span class="line">	ptrace(<span class="number">0xb010</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);	<span class="comment">// marks call to _objcInit</span></span><br><span class="line">	__initialize_objc();</span><br><span class="line">	<span class="comment">/* We delay this until here, because dyld cannot detect and</span></span><br><span class="line"><span class="comment">	 * properly order calls to ObjC initializers amongst the</span></span><br><span class="line"><span class="comment">	 * calls to module and library initializers. */</span></span><br><span class="line">	for (hidx = <span class="number">0</span>; hidx &lt; header_count; hidx += <span class="number">1</span>)</span><br><span class="line">		_objc_call_loads_for_image (&amp;header_vector[hidx]);</span><br><span class="line">	ptrace(<span class="number">0xb01f</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);	<span class="comment">// marks call to _objcInit</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>首先是以下这段代码<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> _done = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">int</span> hidx;</span><br><span class="line">        <span class="comment">/* Protect against multiple invocations, as all library</span></span><br><span class="line"><span class="comment">         * initializers should. */</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="number">0</span> != _done) <span class="keyword">return</span>;</span><br><span class="line">        _done = <span class="number">1</span>;</span><br></pre></td></tr></table></figure></p>
<p>正如他所写的，这个逻辑防止了被多次调用执行，保证了该方法只被执行一次。因为一旦第一次执行了，那么<code>_done</code>这个参数就会被赋值为1，之后调用就会直接<code>return</code></p>
<p>接下来，这里有个<code>ptrace</code>方法,这个方法主要用于断点调试和追踪系统调用。对于实现整体的逻辑实现没有太大影响，我们可以将它忽略。</p>
<p>之后调用了<br><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">__initialize_objc()<span class="comment">;</span></span><br></pre></td></tr></table></figure></p>
<p>该方法是动态链接器用来初始化库文件，通过头文件创建了一个全局的迭代器，并通过类的<code>hash</code>表，和对应头文件的迭代器来获取<code>class</code>。</p>
<h2 id="category-部分"><a href="#category-部分" class="headerlink" title="category 部分"></a>category 部分</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/* Library initializer called by dyld. */</span></span><br><span class="line"><span class="keyword">void</span> __initialize_objc(<span class="keyword">void</span>) &#123;</span><br><span class="line">	<span class="keyword">int</span> hidx;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(NeXT_PDO)</span></span><br><span class="line">	<span class="keyword">const</span> headerType * <span class="keyword">const</span> *	headers;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ( rocketLaunchingDebug == <span class="number">-1</span> ) &#123;</span><br><span class="line">	    <span class="keyword">if</span> ( getenv(<span class="string">"OBJC_UNIQUE_DEBUG"</span>) ) rocketLaunchingDebug = <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">else</span> rocketLaunchingDebug = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Get architecture dependent module headers</span></span><br><span class="line">	headers = (<span class="keyword">const</span> headerType * <span class="keyword">const</span> *) _getObjcHeaders ();</span><br><span class="line">	<span class="keyword">if</span> (headers)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">// Create vector from these headers</span></span><br><span class="line">		header_vector = _objc_headerVector (headers);</span><br><span class="line">		<span class="keyword">if</span> (header_vector) </span><br><span class="line">		&#123;</span><br><span class="line">			<span class="comment">// Load classes from all images in the vector</span></span><br><span class="line">			<span class="keyword">for</span> (hidx = <span class="number">0</span>; hidx &lt; header_count; hidx += <span class="number">1</span>)</span><br><span class="line">				(<span class="keyword">void</span>) _objc_get_classes_from_image (class_hash, &amp;header_vector[hidx]);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(__MACH__)</span></span><br><span class="line">	<span class="keyword">static</span> <span class="keyword">int</span> _done = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">extern</span> <span class="keyword">void</span> __CFInitialize(<span class="keyword">void</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Protect against multiple invocations, as all library</span></span><br><span class="line"><span class="comment">	 * initializers should. */</span></span><br><span class="line">	<span class="keyword">if</span> (<span class="number">0</span> != _done) <span class="keyword">return</span>;</span><br><span class="line">	_done = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">	ptrace(<span class="number">0xb000</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// make sure CF is initialized before we go further;</span></span><br><span class="line">	<span class="comment">// someday this can be removed, as it'll probably be automatic</span></span><br><span class="line">	__CFInitialize();</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Create the class lookup table</span></span><br><span class="line">	_objc_init_class_hash ();</span><br><span class="line">	</span><br><span class="line"><span class="comment">//	ptrace(0xb001, 0, 0, 0);</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// Get our configuration</span></span><br><span class="line">        <span class="keyword">if</span> ( rocketLaunchingDebug == <span class="number">-1</span> ) &#123;</span><br><span class="line">            <span class="keyword">if</span> ( getenv(<span class="string">"OBJC_UNIQUE_DEBUG"</span>) ) rocketLaunchingDebug = <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">else</span> rocketLaunchingDebug = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//	ptrace(0xb003, 0, 0, 0);</span></span><br><span class="line"></span><br><span class="line">	map_selectors_pended = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// XXXXX BEFORE HERE *NO* PAGES ARE STOMPED ON</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// Register our image mapping routine with dyld so it</span></span><br><span class="line">	<span class="comment">// gets invoked when an image is added.  This also invokes</span></span><br><span class="line">	<span class="comment">// the callback right now on any images already present.</span></span><br><span class="line">	_dyld_register_func_for_add_image (&amp;_objc_map_image_callback);</span><br><span class="line">	</span><br><span class="line"><span class="comment">// XXXXX BEFORE HERE *ALL* PAGES ARE STOMPED ON</span></span><br><span class="line"></span><br><span class="line">	map_selectors_pended  = <span class="number">0</span>;</span><br><span class="line">	</span><br><span class="line"><span class="comment">//	ptrace(0xb005, 0, 0, 0);</span></span><br><span class="line">		</span><br><span class="line">	<span class="comment">// Register module link callback with dyld</span></span><br><span class="line">	_dyld_register_func_for_link_module (&amp;_objc_link_module_callback);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Register callback with dyld</span></span><br><span class="line">	_dyld_register_func_for_unlink_module (&amp;_objc_unlink_module_callback);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">// MACH</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//	ptrace(0xb006, header_count, 0, 0);</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// Install relations on classes that were found</span></span><br><span class="line">	<span class="keyword">for</span> (hidx = <span class="number">0</span>; hidx &lt; header_count; hidx += <span class="number">1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">int</span>			nModules;</span><br><span class="line">		<span class="keyword">int</span>			index;</span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">objc_module</span> *	<span class="title">module</span>;</span></span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">objc_class</span> *	<span class="title">cls</span>;</span></span><br><span class="line">		</span><br><span class="line">		<span class="keyword">module</span> = (struct objc_module *) ((<span class="keyword">unsigned</span> <span class="keyword">long</span>) header_vector[hidx].mod_ptr + header_vector[hidx].image_slide);</span><br><span class="line">		<span class="keyword">for</span> (nModules = header_vector[hidx].mod_count; nModules; nModules -= <span class="number">1</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">for</span> (index = <span class="number">0</span>; index &lt; <span class="keyword">module</span>-&gt;symtab-&gt;cls_def_cnt; index += <span class="number">1</span>)</span><br><span class="line">			&#123;</span><br><span class="line">				cls = (struct objc_class *) <span class="keyword">module</span>-&gt;symtab-&gt;defs[index];</span><br><span class="line">				_class_install_relationships (cls, <span class="keyword">module</span>-&gt;version);</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">module</span> += <span class="number">1</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//		ptrace(0xb007, hidx, header_vector[hidx].mod_count, 0);</span></span><br><span class="line">		</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line"><span class="comment">//	ptrace(0xb008, header_count, 0, 0);</span></span><br><span class="line">		</span><br><span class="line">	<span class="keyword">for</span> (hidx = <span class="number">0</span>; hidx &lt; header_count; hidx += <span class="number">1</span>)</span><br><span class="line">	&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> !defined(__MACH__)</span></span><br><span class="line">		(<span class="keyword">void</span>)_objc_add_categories_from_image (&amp;header_vector[hidx]);</span><br><span class="line">		(<span class="keyword">void</span>) _objc_fixup_selector_refs (&amp;header_vector[hidx]);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">		<span class="comment">// Initialize the isa pointers of all NXConstantString objects</span></span><br><span class="line">		(<span class="keyword">void</span>)_objc_fixup_string_objects_for_image (&amp;header_vector[hidx]);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Convert class refs from name pointers to ids</span></span><br><span class="line">		(<span class="keyword">void</span>)_objc_map_class_refs_for_image (&amp;header_vector[hidx]);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//	ptrace(0xb00a, 0, 0, 0);</span></span><br><span class="line">		</span><br><span class="line">	<span class="comment">// For each image selectorize the method names and +_fixup each of</span></span><br><span class="line">	<span class="comment">// protocols in the image</span></span><br><span class="line">	<span class="keyword">for</span> (hidx = <span class="number">0</span>; hidx &lt; header_count; hidx += <span class="number">1</span>)</span><br><span class="line">		_objc_fixup_protocol_objects_for_image (&amp;header_vector[hidx]);</span><br><span class="line">	</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(WIN32) || defined(__svr4__)</span></span><br><span class="line">	CMH = (objcModHeader *) <span class="number">0</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	ptrace(<span class="number">0xb00f</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);	<span class="comment">// end of ObjC init</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>以上的方法中，其中一个比较重要的方法就是</p>
<figure class="highlight gcode"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">_objc_get_classes_from_image<span class="comment">()</span></span><br></pre></td></tr></table></figure>
<p>让我们继续往里深入这个方法</p>
<figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/***********************************************************************</span></span><br><span class="line"><span class="comment"> * _objc_get_classes_from_image.  Install all classes contained in the</span></span><br><span class="line"><span class="comment"> * specified image.</span></span><br><span class="line"><span class="comment"> **********************************************************************/</span></span><br><span class="line"><span class="keyword">static</span> NXHashTable *	_objc_get_classes_from_image   (NXHashTable *	clsHash,</span><br><span class="line">														header_info *	hi)</span><br><span class="line">&#123;</span><br><span class="line">	unsigned int	index;</span><br><span class="line">	unsigned int	midx;</span><br><span class="line">	Module			mods;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// Major loop - process all modules in the image</span></span><br><span class="line">	mods = (Module) ((unsigned long) hi-&gt;mod_ptr + hi-&gt;image_slide);</span><br><span class="line">	<span class="keyword">for</span> (midx = <span class="number">0</span>; midx &lt; hi-&gt;mod_count; midx += <span class="number">1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">// Skip module containing no classes</span></span><br><span class="line">		<span class="keyword">if</span> (mods[midx].symtab == NULL)</span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		</span><br><span class="line">		<span class="comment">// Minor loop - process all the classes in given module</span></span><br><span class="line">		<span class="keyword">for</span> (index = <span class="number">0</span>; index &lt; mods[midx].symtab-&gt;cls_def_cnt; index += <span class="number">1</span>)</span><br><span class="line">		&#123;</span><br><span class="line">		struct objc_class *	oldCls;</span><br><span class="line">		struct objc_class *	<span class="keyword">new</span><span class="type">Cls</span>;</span><br><span class="line">			</span><br><span class="line">			<span class="comment">// Locate the class description pointer</span></span><br><span class="line">			<span class="keyword">new</span><span class="type">Cls</span> = mods[midx].symtab-&gt;defs[index];</span><br><span class="line">			</span><br><span class="line">			<span class="comment">// Convert old style method list to the new style</span></span><br><span class="line">			_objcTweakMethodListPointerForClass (<span class="keyword">new</span><span class="type">Cls</span>);</span><br><span class="line"></span><br><span class="line">			oldCls = NXHashInsert (clsHash, <span class="keyword">new</span><span class="type">Cls</span>);</span><br><span class="line"></span><br><span class="line">			<span class="comment">// Non-Nil oldCls is a class that NXHashInsert just</span></span><br><span class="line">			<span class="comment">// bumped from table because it has the same name</span></span><br><span class="line">			<span class="comment">// as newCls</span></span><br><span class="line">			<span class="keyword">if</span> (oldCls)</span><br><span class="line">			&#123;</span><br><span class="line">        <span class="meta">#<span class="meta-keyword">if</span> defined(__MACH__)</span></span><br><span class="line">				const header_info *	oldHeader;</span><br><span class="line">				const header_info *	<span class="keyword">new</span><span class="type">Header</span>;</span><br><span class="line">				const char *		oldName;</span><br><span class="line">				const char *		<span class="keyword">new</span><span class="type">Name</span>;</span><br><span class="line"></span><br><span class="line">				<span class="comment">// Log the duplication</span></span><br><span class="line">				oldHeader = _headerForClass (oldCls);</span><br><span class="line">				<span class="keyword">new</span><span class="type">Header</span> = _headerForClass (<span class="keyword">new</span><span class="type">Cls</span>);</span><br><span class="line">				oldName   = _nameForHeader  (oldHeader-&gt;mhdr);</span><br><span class="line">				<span class="keyword">new</span><span class="type">Name</span>   = _nameForHeader  (<span class="keyword">new</span><span class="type">Header</span>-&gt;mhdr);</span><br><span class="line">				_objc_inform (<span class="string">"Both %s and %s have implementations of class %s."</span>,</span><br><span class="line">								oldName, <span class="keyword">new</span><span class="type">Name</span>, oldCls-&gt;name);				   </span><br><span class="line">				_objc_inform (<span class="string">"Using implementation from %s."</span>, <span class="keyword">new</span><span class="type">Name</span>);</span><br><span class="line">                <span class="meta">#endif</span></span><br><span class="line"></span><br><span class="line">				<span class="comment">// Use the chosen class</span></span><br><span class="line">				<span class="comment">// <span class="doctag">NOTE:</span> Isn't this a NOP?</span></span><br><span class="line">				<span class="keyword">new</span><span class="type">Cls</span> = objc_lookUpClass (oldCls-&gt;name);</span><br><span class="line">			&#125;</span><br><span class="line">			</span><br><span class="line">			<span class="comment">// Unless newCls was a duplicate, and we chose the</span></span><br><span class="line">			<span class="comment">// existing one instead, set the version in the meta-class</span></span><br><span class="line">			<span class="keyword">if</span> (<span class="keyword">new</span><span class="type">Cls</span> != oldCls)</span><br><span class="line">				<span class="keyword">new</span><span class="type">Cls</span>-&gt;isa-&gt;version = mods[midx].version;</span><br><span class="line"></span><br><span class="line">			<span class="comment">// Install new categories intended for this class</span></span><br><span class="line">			<span class="comment">// <span class="doctag">NOTE:</span> But, if we displaced an existing "isEqual"</span></span><br><span class="line">			<span class="comment">// class, the categories have already been installed</span></span><br><span class="line">			<span class="comment">// on an old class and are gone from the registry!!</span></span><br><span class="line">			_objc_resolve_categories_for_class (<span class="keyword">new</span><span class="type">Cls</span>);</span><br><span class="line">			</span><br><span class="line">			<span class="comment">// Resolve (a) pointers to the named class, and/or</span></span><br><span class="line">			<span class="comment">// (b) the super_class, cache, and version</span></span><br><span class="line">			<span class="comment">// fields of newCls and its meta-class</span></span><br><span class="line">			<span class="comment">// <span class="doctag">NOTE:</span> But, if we displaced an existing "isEqual"</span></span><br><span class="line">			<span class="comment">// class, this has already been done... with an</span></span><br><span class="line">			<span class="comment">// old-now-"unused" class!!</span></span><br><span class="line">			checkForPendingClassReferences (<span class="keyword">new</span><span class="type">Cls</span>);</span><br><span class="line">			</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(NeXT_PDO) // GENERIC_OBJ_FILE</span></span><br><span class="line">			<span class="comment">// Invoke registered callback</span></span><br><span class="line">			<span class="keyword">if</span> (load_class_callback)</span><br><span class="line">				(*load_class_callback) (<span class="keyword">new</span><span class="type">Cls</span>, <span class="number">0</span>);</span><br><span class="line">			</span><br><span class="line">			<span class="comment">// Call +finishLoading:: from the class' method list</span></span><br><span class="line">			send_load_message_to_class (<span class="keyword">new</span><span class="type">Cls</span>, (headerType *) hi-&gt;mhdr);</span><br><span class="line"><span class="meta">#endif</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// Return the table the caller passed</span></span><br><span class="line">	<span class="keyword">return</span> clsHash;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从顶部的注释中，我们可以了解到，这个方法用于加载指定镜像中的所有的类<br>这里我们关注的是category的部分，所以我们看到行代码<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">   // <span class="keyword">Install</span> <span class="keyword">new</span> categories intended <span class="keyword">for</span> this <span class="keyword">class</span></span><br><span class="line">// NOTE: But, <span class="keyword">if</span> we displaced an existing <span class="string">"isEqual"</span></span><br><span class="line">// <span class="keyword">class</span>, the categories have already been installed</span><br><span class="line">// <span class="keyword">on</span> an <span class="keyword">old</span> <span class="keyword">class</span> <span class="keyword">and</span> <span class="keyword">are</span> gone <span class="keyword">from</span> the registry!!</span><br><span class="line">_objc_resolve_categories_for_class (newCls);</span><br></pre></td></tr></table></figure></p>
<p>该方法被用于加载新的<code>category</code>，注释中也提到了，如果我们取代了已经存在的同一个类，那么之前已经被加载在旧的类上的<code>category</code>就会从寄存器中消失</p>
<p>对应的是现实这样的</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="markdown">/<span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span>*</span></span></span><br><span class="line"><span class="comment"><span class="markdown"> * <span class="emphasis">_objc_</span>resolve<span class="emphasis">_categories_</span>for_class.  Install all categories intended</span></span></span><br><span class="line"><span class="comment"><span class="markdown"> * for </span>the<span class="markdown"> specified class, in reverse order from </span>the<span class="markdown"> order in which we</span></span></span><br><span class="line"><span class="comment"><span class="markdown"> * found </span>the<span class="markdown"> categories in </span>the<span class="markdown"> image.</span></span></span><br><span class="line"><span class="comment"><span class="markdown"> <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span>/</span></span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span>	_objc_resolve_categories_for_class  (struct objc_class *	cls)</span><br><span class="line">&#123;</span><br><span class="line">	_objc_unresolved_category *	cat;</span><br><span class="line">	_objc_unresolved_category *	next;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// Nothing to do if there are no categories at all</span></span><br><span class="line">	<span class="keyword">if</span> (!category_hash)</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// Locate and remove first element in category list</span></span><br><span class="line">	<span class="comment">// associated with this class</span></span><br><span class="line">	cat = NXMapRemove (category_hash, cls-&gt;name);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// Traverse the list of categories, if any, registered for this class</span></span><br><span class="line">	<span class="keyword">while</span> (cat)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">// Install the category</span></span><br><span class="line">		_objc_add_category (cat-&gt;cat, cat-&gt;version);</span><br><span class="line">		</span><br><span class="line">		<span class="comment">// Delink and reclaim this registration</span></span><br><span class="line">		next = cat-&gt;next;</span><br><span class="line">		free (cat);</span><br><span class="line">		cat = next;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里我们观察到有个叫<code>category_hash</code>的哈希表，之后遍历单向链表结构，将对应的<code>category</code>添加到对象中</p>
<p>这里我们会有两个疑问🤔️</p>
<p>1.<code>category_hash</code>这个变量那里来的？<br>2.<code>_objc_add_category</code>又做了什么操作？</p>
<hr>
<p>那么我们先解答第一个</p>
<blockquote>
<p>1.<code>category_hash</code>这个变量那里来的？</p>
</blockquote>
<p>事实上，<code>category_hash</code>是一个全局变量<br><figure class="highlight monkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">// Category <span class="literal">and</span> <span class="class"><span class="keyword">class</span> <span class="title">registries</span></span></span><br><span class="line">static NXMapTable *		category_hash = <span class="literal">NULL</span>;</span><br></pre></td></tr></table></figure></p>
<p>在<code>__initialize_objc()</code>这个方法中有这样一行代码</p>
<figure class="highlight sqf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"> <span class="comment">// Register our image mapping routine with dyld so it</span></span><br><span class="line"><span class="comment">// gets invoked when an image is added.  This also invokes</span></span><br><span class="line"><span class="comment">// the callback right now on any images already present.</span></span><br><span class="line"><span class="variable">_dyld_register_func_for_add_image</span> (&amp;<span class="variable">_objc_map_image_callback</span>);</span><br></pre></td></tr></table></figure>
<p>在这个方式中，我们传入了一个回调方法，也就是说当每个镜像被加载的时候都会调用这个回调方法，具体可见<a href="http://mirror.informatimago.com/next/developer.apple.com/documentation/DeveloperTools/Conceptual/MachORuntime/5rt_api_reference/chapter_11_section_46.html" target="_blank" rel="noopener">这里</a></p>
<p>之后经过一系列调用最终在<code>_objc_register_category</code>这个方法中创建了这个<code>category</code>哈希表</p>
<p><strong>所以</strong></p>
<p>这个哈希表的创建是在每次镜像被加载时创建的，同时他也会去做对比，如果出现重复就会进行替换操作</p>
<hr>
<blockquote>
<p>2.<code>_objc_add_category</code>又做了什么操作？</p>
</blockquote>
<p>直接看代码</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="markdown">/<span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span>*</span></span></span><br><span class="line"><span class="comment"><span class="markdown"> * <span class="emphasis">_objc_</span>add_category.  Install </span>the<span class="markdown"> specified category's methods into</span></span></span><br><span class="line"><span class="comment"><span class="markdown"> * </span>the<span class="markdown"> class it augments, and flush </span>the<span class="markdown"> class' method cache.</span></span></span><br><span class="line"><span class="comment"><span class="markdown"> *</span></span></span><br><span class="line"><span class="comment"><span class="markdown"> * Private extern used by objc_loadModules ()</span></span></span><br><span class="line"><span class="comment"><span class="markdown"> <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span>/</span></span></span><br><span class="line"><span class="keyword">void</span>	_objc_add_category     (struct objc_category *	category,</span><br><span class="line">								<span class="built_in">int</span>						version)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">// Install the category's methods into its intended class</span></span><br><span class="line">	__objc_add_category (category, version);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// Flush caches so category's methods can get called</span></span><br><span class="line">	_objc_flush_caches (objc_lookUpClass (category-&gt;class_name));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注释十分清晰，主要干了<strong>两件事</strong></p>
<ul>
<li>1.加载特定类方法</li>
<li>2.刷新类的方法缓存</li>
</ul>
<p>关于<code>__objc_add_category</code>我们需要进一步去深入</p>
<figure class="highlight xl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/***********************************************************************</span></span><br><span class="line"><span class="comment"> * __objc_add_category.  Install the specified category's methods and</span></span><br><span class="line"><span class="comment"> * protocols into the class it augments.</span></span><br><span class="line"><span class="comment"> **********************************************************************/</span></span><br><span class="line">static inline void	__objc_add_category    (struct objc_category *	category,</span><br><span class="line">											int						version)</span><br><span class="line">&#123;</span><br><span class="line">	struct objc_class *	cls;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// Locate the class that the category will extend</span></span><br><span class="line">	<span class="function"><span class="title">cls</span> = (struct objc_class *) objc_getClass (category-&gt;</span>class_name);</span><br><span class="line">	<span class="keyword">if</span> (!cls)</span><br><span class="line">	&#123;</span><br><span class="line">		_<span class="function"><span class="title">objc_inform</span> ("unable to add category %s...\n", category-&gt;</span>category_name);</span><br><span class="line">		_<span class="function"><span class="title">objc_inform</span> ("class `%s' <span class="built_in">not</span> linked into application\n", category-&gt;</span>class_name);</span><br><span class="line">		return;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Augment instance methods</span></span><br><span class="line">	<span class="function"><span class="title">if</span> (category-&gt;</span>instance_methods)</span><br><span class="line">		_<span class="function"><span class="title">objc_insertMethods</span> (category-&gt;</span><span class="function"><span class="title">instance_methods</span>, &amp;cls-&gt;</span>methodLists);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Augment class methods</span></span><br><span class="line">	<span class="function"><span class="title">if</span> (category-&gt;</span>class_methods)</span><br><span class="line">		_<span class="function"><span class="title">objc_insertMethods</span> (category-&gt;</span><span class="function"><span class="title">class_methods</span>, &amp;cls-&gt;</span><span class="function"><span class="title">isa</span>-&gt;</span>methodLists);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Augment protocols</span></span><br><span class="line">	<span class="function"><span class="title">if</span> ((version &gt;= 5) &amp;&amp; category-&gt;</span>protocols)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="function"><span class="title">if</span> (cls-&gt;</span><span class="function"><span class="title">isa</span>-&gt;</span>version &gt;= <span class="number">5</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="function"><span class="title">category</span>-&gt;</span><span class="function"><span class="title">protocols</span>-&gt;</span><span class="function"><span class="title">next</span> = cls-&gt;</span>protocols;</span><br><span class="line">			<span class="function"><span class="title">cls</span>-&gt;</span><span class="function"><span class="title">protocols</span>	          = category-&gt;</span>protocols;</span><br><span class="line">			<span class="function"><span class="title">cls</span>-&gt;</span><span class="function"><span class="title">isa</span>-&gt;</span><span class="function"><span class="title">protocols</span>       = category-&gt;</span>protocols;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">		&#123;</span><br><span class="line">			_<span class="function"><span class="title">objc_inform</span> ("unable to add protocols from category %s...\n", category-&gt;</span>category_name);</span><br><span class="line">			_<span class="function"><span class="title">objc_inform</span> ("class `%s' must be recompiled\n", category-&gt;</span>class_name);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">#<span class="keyword">if</span> defined(NeXT_PDO) <span class="comment">// GENERIC_OBJ_FILE</span></span><br><span class="line">	<span class="comment">// Call back</span></span><br><span class="line">	<span class="keyword">if</span> (load_class_callback)</span><br><span class="line">		(*load_class_callback) (cls, <span class="number">0</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// Call +finishLoading:: from the category's method list</span></span><br><span class="line">	send_load_message_to_category (category, (void *) header_vector[<span class="number">0</span>].mhdr);</span><br><span class="line">#endif</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们可以看到，他会分别对<strong>实例对象的方法列表</strong>和<strong>类对象的方法列表</strong>分别添加实例方法和类方法。</p>
<p>总结： </p>
<p>1.dyld在每次加载镜像的时候，都会调用回调方法，让系统生成类对应的<code>category</code>哈希表<br>2.每次对应添加方法时都会是分别添加对应的实例方法和类方法</p>

        
      
    </div>

    <div class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </div>
  </div>


    
      

  <div class="post post-type-normal ">
    <div class="post-header">

      
      
        <h1 class="post-title">
          
          
            
              <a class="post-title-link" href="/2018/06/25/加密相关（二）/">
                加密相关（二）
              </a>
            
          
        </h1>
      

      <div class="post-meta">
        <span class="post-time">
          Posted on 2018-06-25
        </span>

        
          <span class="post-category">
            &nbsp; | &nbsp; In
            
              <a href="/categories/Read-iOS/">Read iOS</a>

              
              

            
          </span>
        

        
          
        
      </div>
    </div>

    <div class="post-body">

      
      

      
        
          <p>基于第一篇文章的介绍，接下来我们来聊聊日常生活中的都会接触到的加密应用方式–<code>HTTPS</code></p>
<h2 id="HTTP-vs-HTTPS"><a href="#HTTP-vs-HTTPS" class="headerlink" title="HTTP vs HTTPS"></a>HTTP vs HTTPS</h2><p><code>HTTP</code>全称<code>Hyper Text Transfer Protocal</code>(超文本传输协议)是万维网服务器传输超文本协议到本地浏览器的传送协议，是一个属于应用层的面向对象的协议。</p>
<p><code>HTTPS</code>全称<code>Secure Hypertext Transfer Protocol</code>安全超文本传输协议。</p>
<h2 id="SSL-or-TLS"><a href="#SSL-or-TLS" class="headerlink" title="SSL or TLS"></a>SSL or TLS</h2><p>在<code>HTTPS</code>中的<code>S</code>可以是<code>SSL</code>或者<code>TLS</code>。</p>
<p><code>SSL</code>全称<code>Secure Socket Layer</code>安全套接字层，位于可靠的面向连接的网络协议和应用层协议层。<code>SSL</code>通过互相认证、使用数字证书保证完整性，使用加密确保私密性，以实现客户端和服务器之间的安全通讯。该协议由两层组成: <code>SSL</code>记录协议和<code>SSL</code>握手协议。<code>SSL</code>是<code>Netscape</code>开发的专门用于保护<code>Web</code>通讯的。</p>
<p><code>TLS</code>全称<code>Transport Layer Security</code>安全传输层协议，用于两个应用之间提供保密性和数据完整性。该协议由两层组成:  <code>TSL</code>记录协议和<code>TSL</code>握手协议。<br>
          <div class="post-more-link text-center">
            <a class="btn" href="/2018/06/25/加密相关（二）/#more">
              Read more &raquo;
            </a>
          </div>
        
      
    </div>

    <div class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </div>
  </div>


    
      

  <div class="post post-type-normal ">
    <div class="post-header">

      
      
        <h1 class="post-title">
          
          
            
              <a class="post-title-link" href="/2018/06/02/setTimeout探索/">
                setTimeout探索
              </a>
            
          
        </h1>
      

      <div class="post-meta">
        <span class="post-time">
          Posted on 2018-06-02
        </span>

        
          <span class="post-category">
            &nbsp; | &nbsp; In
            
              <a href="/categories/FrontEnd/">FrontEnd</a>

              
              

            
          </span>
        

        
          
        
      </div>
    </div>

    <div class="post-body">

      
      

      
        
          <h2 id="背景知识"><a href="#背景知识" class="headerlink" title="背景知识"></a>背景知识</h2><blockquote>
<p>并发&amp;&amp;并行</p>
</blockquote>
<p><strong>并发多线程</strong> : <code>ConCurrency</code> , 实质就是一个物理的<code>CPU</code>在若干个程序之间复用，由于每次切换执行程序的时间极短，所以一般用户无法察觉，即认为是多个应用在同时执行。<br><strong>并行多线程</strong> : <code>Paralleism</code> , 指两个或两个以上的事件在同一时刻发生，是真正意义上的不同事件在同一个时刻发送。</p>
<blockquote>
<p>JS线程</p>
</blockquote>
<p>浏览器内核是多线程的，在一般情况下，会保留至少三个基本线程：<strong>JS引擎线程</strong>、<strong>GUI渲染线程</strong>、<strong>浏览器事件触发线程</strong></p>
<p><strong>JS引擎线程</strong>: 基于事件执行，单线程处理，意味着任务都是一个接一个顺序执行的。<br><strong>GUI渲染线程</strong>: 负责渲染浏览器界面<br><strong>浏览器事件触发线程</strong>: 当一个事件触发时该线程会把事件添加到<code>JS引擎线程</code>的待处理队列的队尾中</p>
          <div class="post-more-link text-center">
            <a class="btn" href="/2018/06/02/setTimeout探索/#more">
              Read more &raquo;
            </a>
          </div>
        
      
    </div>

    <div class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </div>
  </div>


    
      

  <div class="post post-type-normal ">
    <div class="post-header">

      
      
        <h1 class="post-title">
          
          
            
              <a class="post-title-link" href="/2018/05/23/加密相关（一）/">
                加密相关（一）
              </a>
            
          
        </h1>
      

      <div class="post-meta">
        <span class="post-time">
          Posted on 2018-05-23
        </span>

        
          <span class="post-category">
            &nbsp; | &nbsp; In
            
              <a href="/categories/Read/">Read</a>

              
              

            
          </span>
        

        
          
        
      </div>
    </div>

    <div class="post-body">

      
      

      
        
          <blockquote>
<p>前言：<br> <strong>这会是一篇主讲加密相关的文章，希望能在一定程度上理清日常使用的加密概念。</strong></p>
</blockquote>
<h3 id="对称加密与非对称加密"><a href="#对称加密与非对称加密" class="headerlink" title="对称加密与非对称加密"></a>对称加密与非对称加密</h3><p>首先，现有的加密技术分为两种，一种叫<code>对称加密</code>，即在加密和解密的时候使用的是同一个密钥。另一种叫<code>非对称加密</code>，这种加密技术中，存在两个概念—私钥和公钥。私钥一般是指，用于加密原文的不向外界透露的密钥。公钥则想法，一般是指向外界透露的，用于解密的密钥。其中公钥和私钥是一一对应关系，即只有私钥对应的公钥才能解密私钥加密的密文</p>
<hr>
          <div class="post-more-link text-center">
            <a class="btn" href="/2018/05/23/加密相关（一）/#more">
              Read more &raquo;
            </a>
          </div>
        
      
    </div>

    <div class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </div>
  </div>


    
      

  <div class="post post-type-normal ">
    <div class="post-header">

      
      
        <h1 class="post-title">
          
          
            
              <a class="post-title-link" href="/2018/04/12/autoreleasepool分析/">
                autoreleasepool分析
              </a>
            
          
        </h1>
      

      <div class="post-meta">
        <span class="post-time">
          Posted on 2018-04-12
        </span>

        
          <span class="post-category">
            &nbsp; | &nbsp; In
            
              <a href="/categories/ScourceCode/">ScourceCode</a>

              
              

            
          </span>
        

        
          
        
      </div>
    </div>

    <div class="post-body">

      
      

      
        
          <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Autorelease pool implementation</span><br><span class="line">A thread's autorelease pool is a stack of pointers. </span><br><span class="line">Each pointer is either an object to <span class="keyword">release</span>, <span class="keyword">or</span> POOL_SENTINEL which <span class="keyword">is</span> </span><br><span class="line"> an autorelease pool boundary.</span><br><span class="line">A pool token <span class="keyword">is</span> a pointer <span class="keyword">to</span> the POOL_SENTINEL <span class="keyword">for</span> that pool. <span class="keyword">When</span> </span><br><span class="line"> the pool <span class="keyword">is</span> popped, every <span class="keyword">object</span> hotter <span class="keyword">than</span> the sentinel <span class="keyword">is</span> released.</span><br><span class="line">The stack <span class="keyword">is</span> divided <span class="keyword">into</span> a doubly-linked <span class="keyword">list</span> <span class="keyword">of</span> pages. Pages <span class="keyword">are</span> added </span><br><span class="line"> <span class="keyword">and</span> deleted <span class="keyword">as</span> necessary. </span><br><span class="line"><span class="keyword">Thread</span>-<span class="keyword">local</span> <span class="keyword">storage</span> points <span class="keyword">to</span> the hot page, <span class="keyword">where</span> newly autoreleased objects <span class="keyword">are</span> stored.</span><br></pre></td></tr></table></figure>
<p>翻译：<br>一个线程的自动释放池是一堆指针。指针要么是一个<code>release</code>对象，要么是一个<code>POOL_SENTINEL</code> — <code>POOL_SENTINEL</code>是一个自动回收池边界</p>
<p>一个<code>pool token</code>对于那个释放池来讲是一个指向<code>POOL_SENTINEL</code>(池子哨兵)的指针。当池子被释放时，每个比哨兵hotter的对象都要被释放–不是很懂。这个栈被划分为一系列双向列表，列表根据需要添加或者删除</p>
<p>TLS指针指向<code>hot page</code>，他就是最新的自动释放对对象存储的地方<br>
          <div class="post-more-link text-center">
            <a class="btn" href="/2018/04/12/autoreleasepool分析/#more">
              Read more &raquo;
            </a>
          </div>
        
      
    </div>

    <div class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </div>
  </div>


    
  </div>

  
  <div class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/2/">&raquo;</a>
  </div>


        </div>

        
      </div>


      
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <div id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      <div class="site-overview">
        <div class="site-author motion-element">
          <img class="site-author-image" src="http://7xjg07.com1.z0.glb.clouddn.com/u=3987586330,3835281882&fm=21&gp=0.jpg" alt="Deeer" />
          <p class="site-author-name">Deeer</p>
        </div>
        <p class="site-description motion-element">代码手工艺人 | Love Linux  | 追求体验</p>
        <div class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">14</span>
              <span class="site-state-item-name">posts</span>
            </a>
          </div>

          <div class="site-state-item site-state-categories">
            <a href="/categories">
              <span class="site-state-item-count">8</span>
              <span class="site-state-item-name">categories</span>
              </a>
          </div>

          <div class="site-state-item site-state-tags">
            <a href="/tags">
              <span class="site-state-item-count">11</span>
              <span class="site-state-item-name">tags</span>
              </a>
          </div>

        </div>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml">
              <i class="menu-item-icon icon-feed"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
              <a href="http://weibo.com/2941461951/profile?topnav=1&wvr=6" target="_blank">weibo</a>
            </span>
            
              <span class="links-of-author-item">
              <a href="https://github.com/Deeer" target="_blank">github</a>
            </span>
            
          
        </div>

        
        

      </div>

      

    </div>
  </div>


    </div>

    <div id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">
  
  &copy; &nbsp;  2015 - 
  2018
  <span class="with-love">
    <i class="icon-heart"></i>
  </span>
  <span class="author">Deeer</span>
</div>

<div class="powered-by">
  Powered by <a class="theme-link" href="http://hexo.io">Hexo</a>
</div>

<div class="theme-info">
  Theme -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>



      </div>
    </div>

    <div class="back-to-top"></div>
  </div>

  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  

  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js"></script>
  <script type="text/javascript" src="/js/fancy-box.js"></script>


  <script type="text/javascript" src="/js/helpers.js"></script>
  

  <script type="text/javascript" src="/vendors/velocity/velocity.min.js"></script>
  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js"></script>

  <script type="text/javascript" src="/js/motion_global.js" id="motion.global"></script>




  

  <script type="text/javascript">
    $(document).ready(function () {
      if (CONFIG.sidebar === 'always') {
        displaySidebar();
      }
    });
  </script>

  

  
  
  

  




  
  

</body>
</html>
